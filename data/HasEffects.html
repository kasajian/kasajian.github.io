Visual Studio Analyzer

I want a Roslyn analyzer which does the following:

If a method lacks a particularly attribute annotation, I want to generate a warning if any of the methods it calls has a particular attribute.

Imagine I have the following Attributes:

    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Property | AttributeTargets.Class | AttributeTargets.Struct | AttributeTargets.Interface)]

    public class HasEffects : Attribute

    {

        public HasEffects(params string[] effect) { }

    }

and:

    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Property | AttributeTargets.Class | AttributeTargets.Struct | AttributeTargets.Interface)]

    public class WithEffects : Attribute

    {

        public WithEffects(params string[] effect) { }

    }

Along with helper class:

    public static class SideEffect

    {

        public const string IO = "IO";

        public const string State = "State";

    }

}

In the following example, the side-effect “State” is adorned on the method CurrentTime().   Therefore, the call to CurrentTime() in CheckDifference(), as highlighted, should be flagged as a warning because the definition of the CheckDifference() method should also have an annotation.

Incorrect:

    public class UpdateBackend

    {

        public void CheckDifference(int id)

        {

            var stamp = GetStamp(id);

            var currentTime = CurrentTime();

            StoreChanges(stamp, currentTime);

        }

 

        [HasEffects(SideEffect.State)]

        public DateTime CurrentTime()

        {

            return DateTime.Now;

        }

 

Correct

    public class UpdateBackend

    {

        [WithEffects(SideEffect.State)] // Attribute added to remove warning.

        public void CheckDifference(int id)

        {

            var stamp = GetStamp(id);

            var currentTime = CurrentTime();

            StoreChanges(stamp, currentTime);

        }

 

        [HasEffects(SideEffect.State)]

        public DateTime CurrentTime()

        {

            return DateTime.Now;

        }

 

Because the method CurrentTime() uses DateTime.Now, it has the “State” effect, as indicated by the HasEffects() attribute.   Therefore, all callers of CurrentTime, such as CheckDifference(), must be annotated with either HasEffects or WithAffects.

The difference between HasEffects and WithEffects is as follows:

1.      Method annotated with HasEffects can only be called by methods that are annotated by HasEffects or WithEffects

2.      Method annotated WithEffects must call at least one method annotated by HasEffects or WithEffects

 

In the above example, rule 1 causes the light-blue warning to be generated.

 

However, if you then modify the implementation of CurrentTime() and remove DateTime.Now, and its associated HasEffects annocation, it’s not longer necessary (or valid) for CheckDifference to be annotated with WithEffects   So based on rule 1, the WithEffects attribute must be removed from CheckDifference at this point.  The Analyzer should catch that and report it as a warning.

 
